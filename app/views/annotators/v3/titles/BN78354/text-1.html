{% extends "app/views/layouts/entry-annotation.html" %}

{% set backLinkText = "Back to task overview" %}
{% set backLinkHref = "/annotators/v3/titles/BN78354/entries-task-list" %}

{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/details/macro.njk" import govukDetails %}

{% block pageTitle %}
BN78354 – {{ serviceName }} – GOV.UK Prototype Kit
{% endblock %}

{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% block beforeContent %}

{{ super() }}
{{ govukBackLink({
text: backLinkText,
href: backLinkHref
}) }}

{% endblock %}

{% block content %}

<div class="govuk-grid-row">

  <div class="govuk-grid-column-one-half">
    <h2 class="govuk-heading-m">
      <span>Shape</span>
      <span id="counter">1 of 3</span>
    </h2>

    <div class="style-container">
      <div id="style-box"></div>
      <div id="style-description" class="govuk-label">Style</div>
    </div>

    <div>
      <div class="zoom-controls">
        <button id="zoom-in" class="zoom ol-zoom-in zoom-in" type="button" title="Zoom in">+<span
            class="govuk-visually-hidden">Zoom in</span></button>
        <button id="zoom-out" class="zoom ol-zoom-out zoom-out" type="button" title="Zoom out">-
          <span class="govuk-visually-hidden">Zoom out</span>
        </button>
      </div>
    </div>
    <div id="map" class="maintain-llc-map" tabindex="0" aria-label="Image showing search extent">
      <noscript>
        <div id="nojs" class="nojs-content">
          <div id="nojs-message" class="notification-summary">
            <p>
              You need to turn on JavaScript to use this service. Or, for assistance, please use the
              following link -
              <a id="“assistance-link”"
                href="https://customerhelp.landregistry.gov.uk/local-land-charges">https://customerhelp.landregistry.gov.uk/local-land-charges</a>
            </p>
          </div>
        </div>
      </noscript>
    </div>
  </div>

  <div class="govuk-grid-column-one-third">
    <form action="/annotators/v3/save-answers" method="post" novalidate>

      <input type="hidden" name="titleNumber" value="BN78354">
      <input type="hidden" name="completedTextTitle" id="completed-text-title">

      <div>
        <h2 class="govuk-heading-m">Text 1</h2>

        <div class="entry-container">
          {% include "app/includes/entries/BN78354/inc_BN78354-entry-1.html" %}
        </div>

        {% include "app/includes/annotators/entry-extent-match-radios.html" %}

        <div id="hidden-answers-container"></div>

        <div class="govuk-button-group">
          <button id="prevBtn" class="govuk-button govuk-button--secondary" data-module="govuk-button" type="button">
            Previous shape
          </button>
          <br />
          <button id="nextBtn" class="govuk-button govuk-button--primary" data-module="govuk-button" type="submit">
            Save and next shape
          </button>
          <input type="hidden" name="BN78354Status" value="started">
          <br />
        </div>
      </div>
      <div style="height:480px;">
      </div>
    </form>
  </div>

</div>

{% endblock %}

{% block pageScripts %}

<link rel="stylesheet" href="/public/map/css/map-styles.css">

<script src="/public/map/jquery.min.js"></script>
<script src="/public/map/ol.js"></script>
<script src="/public/map/proj4.js"></script>

<script type="text/javascript">

  // ===================================================================
  // PART 1: PAGE-SPECIFIC CONFIGURATION
  // ===================================================================

  const groupStyles = [
    { color: 'rgba(51, 102, 51, 1)', description: "Group 1 Style" },
    { color: 'rgba(51, 102, 51, 1)', description: "Group 2 Style" },
    { color: 'rgba(51, 102, 51, 1', description: "Group 3 Style" }
  ];

  const extents = [
    // --- GROUP 1 ---
    {
      "type": "FeatureCollection",
      "properties": { "id": "group1" },
      "features": [
        {
          "type": "Feature", "properties": { "featureType": "shape_polygon", "description": "Edged green" },
          "geometry": {
            "type": "Polygon", "coordinates": [[[
              360255.416,
              174262.873
            ],
            [
              360256.886,
              174266.78
            ],
            [
              360257.708,
              174268.964
            ],
            [
              360259.727,
              174274.331
            ],
            [
              360261.809,
              174279.865
            ],
            [
              360262.559,
              174281.859
            ],
            [
              360264.2,
              174286.22
            ],
            [
              360266.256,
              174285.502
            ],
            [
              360267.55,
              174285.05
            ],
            [
              360271.5,
              174283.7
            ],
            [
              360277,
              174281.75
            ],
            [
              360279.907,
              174289.777
            ],
            [
              360280.342,
              174290.978
            ],
            [
              360280.431,
              174290.918
            ],
            [
              360280.35,
              174291
            ],
            [
              360274.2,
              174297.35
            ],
            [
              360272.804,
              174298.791
            ],
            [
              360272.147,
              174299.437
            ],
            [
              360269.975,
              174301.572
            ],
            [
              360267.975,
              174303.539
            ],
            [
              360267.15,
              174304.35
            ],
            [
              360263.1,
              174308.85
            ],
            [
              360262.815,
              174308.039
            ],
            [
              360261.55,
              174304.45
            ],
            [
              360258.55,
              174296.1
            ],
            [
              360258.1,
              174294.65
            ],
            [
              360256.023,
              174288.752
            ],
            [
              360255.01,
              174285.873
            ],
            [
              360251.099,
              174274.767
            ],
            [
              360248.904,
              174268.533
            ],
            [
              360247.822,
              174265.461
            ],
            [
              360247.319,
              174264.033
            ],
            [
              360245.832,
              174259.809
            ],
            [
              360245.595,
              174259.136
            ],
            [
              360249.973,
              174257.627
            ],
            [
              360253.044,
              174256.568
            ],
            [
              360255.416,
              174262.873
            ]
            ]]
          }
        },
        {
          "type": "Feature", "properties": { "featureType": "arrow_line" },
          "geometry": { "type": "LineString", "coordinates": [[360259.813, 174291.088], [360299.34, 174276.952]] }
        },
        {
          "type": "Feature", "properties": { "featureType": "arrow_head" },
          "geometry": { "type": "Polygon", "coordinates": [[[360299.141, 174276.395], [360300.099, 174276.682], [360299.54, 174277.511], [360299.34, 174276.952], [360299.141, 174276.395]]] }
        },
        {
          "type": "Feature", "properties": { "featureType": "label", "text": "BL124172" },
          "geometry": { "type": "Point", "coordinates": [360310.759, 174275.494] }
        }
      ]
    },
    // --- GROUP 2 ---
    {
      "type": "FeatureCollection",
      "properties": { "id": "group2" },
      "features": [
        {
          "type": "Feature", "properties": { "featureType": "shape_polygon", "description": "Edged green" },
          "geometry": {
            "type": "Polygon", "coordinates": [[[
              360293.301,
              174258.003
            ],
            [
              360294.9,
              174263.4
            ],
            [
              360293.7,
              174263.756
            ],
            [
              360293.55,
              174263.8
            ],
            [
              360290.5,
              174264.75
            ],
            [
              360291,
              174266.2
            ],
            [
              360291.6,
              174267.9
            ],
            [
              360287.7,
              174269.45
            ],
            [
              360286.8,
              174267.3
            ],
            [
              360286.35,
              174266.05
            ],
            [
              360286,
              174265.25
            ],
            [
              360284.75,
              174262.35
            ],
            [
              360284.4,
              174261.45
            ],
            [
              360284.144,
              174260.794
            ],
            [
              360283.645,
              174259.471
            ],
            [
              360283.565,
              174259.321
            ],
            [
              360281.55,
              174254.15
            ],
            [
              360291.3,
              174251.25
            ],
            [
              360293.276,
              174257.895
            ],
            [
              360293.301,
              174258.003
            ]
            ]]
          }
        },
        {
          "type": "Feature", "properties": { "featureType": "arrow_line" },
          "geometry": {
            "type": "LineString", "coordinates": [[
              360287.55,
              174254.644
            ],
            [
              360299.33,
              174272.099
            ],
            [
              360298.839,
              174272.431
            ],
            [
              360299.781,
              174272.768
            ],
            [
              360299.82,
              174271.768
            ],
            [
              360299.33,
              174272.099
            ]
            ]
          }
        },
        {
          "type": "Feature", "properties": { "featureType": "arrow_head" },
          "geometry": { "type": "Polygon", "coordinates": [[[360399.141, 174376.395], [360400.099, 174376.682], [360399.54, 174377.511], [360399.34, 174376.952], [360399.141, 174376.395]]] }
        },
        {
          "type": "Feature", "properties": { "featureType": "label", "text": "BL124172" },
          "geometry": { "type": "Point", "coordinates": [360310.759, 174275.494] }
        }
      ]
    },
    // --- GROUP 3 ---
    {
      "type": "FeatureCollection",
      "properties": { "id": "group3" },
      "features": [
        {
          "type": "Feature", "properties": { "featureType": "shape_polygon", "description": "Edged green" },
          "geometry": {
            "type": "Polygon", "coordinates": [[[
              360278.75,
              174275.65
            ],
            [
              360279.693,
              174278.132
            ],
            [
              360279.7,
              174278.15
            ],
            [
              360276,
              174279.45
            ],
            [
              360275.411,
              174279.658
            ],
            [
              360275.014,
              174278.586
            ],
            [
              360273.185,
              174273.649
            ],
            [
              360272.343,
              174271.378
            ],
            [
              360267.565,
              174258.484
            ],
            [
              360269.65,
              174257.75
            ],
            [
              360271.75,
              174257.05
            ],
            [
              360272,
              174257.75
            ],
            [
              360274.73,
              174264.98
            ],
            [
              360275.753,
              174267.649
            ],
            [
              360278.75,
              174275.65
            ]
            ]]
          }
        },
        {
          "type": "Feature", "properties": { "featureType": "arrow_line" },
          "geometry": {
            "type": "LineString", "coordinates": [[
              360272.373,
              174264.222
            ],
            [
              360299.173,
              174274.253
            ],
            [
              360298.965,
              174274.807
            ],
            [
              360299.927,
              174274.535
            ],
            [
              360299.38,
              174273.699
            ],
            [
              360299.173,
              174274.253
            ]
            ]
          }
        },
        {
          "type": "Feature", "properties": { "featureType": "arrow_head" },
          "geometry": {
            "type": "Polygon", "coordinates": [[[
              360299.38,
              174273.699
            ],
            [
              360299.927,
              174274.535
            ],
            [
              360298.965,
              174274.807
            ],
            [
              360299.173,
              174274.253
            ],
            [
              360299.38,
              174273.699
            ]
            ]]
          }
        },
        {
          "type": "Feature", "properties": { "featureType": "label", "text": "BL124172" },
          "geometry": { "type": "Point", "coordinates": [360310.759, 174275.494] }
        }
      ]
    }
  ];

  // ===================================================================
  // PART 2: MAIN APPLICATION LOGIC
  // ===================================================================
  $(window).on('load', function () {
    let count = 0;
    let answers = new Array(extents.length).fill(null);

    const inactiveStyle = new ol.style.Style({
      fill: new ol.style.Fill({ color: 'rgba(100, 100, 100, 0.1)' }),
      stroke: new ol.style.Stroke({ color: 'rgba(100, 100, 100, 0.2)', width: 2 })
    });

    function createActiveStyles(color) {
      const arrowAndLabelColor = '#505a5f'; // Grey for arrows and labels
      return {
        shapePolygon: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: color, width: 4 })
        }),
        arrowLine: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: arrowAndLabelColor, width: 4 })
        }),
        arrowHead: new ol.style.Style({
          fill: new ol.style.Fill({ color: arrowAndLabelColor }),
          stroke: new ol.style.Stroke({ color: arrowAndLabelColor, width: 2 })
        }),
        shapeLine: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: color, width: 4 })
        }),
        label: new ol.style.Style({
          text: new ol.style.Text({
            font: 'bold 32px "Arial", arial, sans-serif',
            fill: new ol.style.Fill({ color: arrowAndLabelColor }),
            stroke: new ol.style.Stroke({ color: 'white', width: 4 }),
            offsetX: 0,
            offsetY: 0,
            textAlign: 'left'
          })
        })
      };
    }

    const styleCache = {};

    const styleFunction = function (feature) {
      const featureGroupId = feature.get('groupId');
      const currentGroupId = extents[count].properties.id;

      if (featureGroupId === currentGroupId) {
        const featureType = feature.get('featureType');
        const color = groupStyles[count].color;

        if (!styleCache[color]) {
          styleCache[color] = createActiveStyles(color);
        }
        const activeStyles = styleCache[color];

        switch (featureType) {
          case 'shape_polygon':
            return activeStyles.shapePolygon;
          case 'arrow_line':
            return activeStyles.arrowLine;
          case 'arrow_head':
            return activeStyles.arrowHead;
          case 'shape_line':
            return activeStyles.shapeLine;
          case 'label':
            const labelStyle = activeStyles.label;
            labelStyle.getText().setText(feature.get('text'));
            return labelStyle;
          default:
            return inactiveStyle;
        }
      }
      return inactiveStyle;
    };

    proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs");
    ol.proj.proj4.register(proj4);
    const projection = ol.proj.get('EPSG:27700');

    const vectorSource = new ol.source.Vector();
    const vectorLayer = new ol.layer.Vector({ source: vectorSource, style: styleFunction });
    const baseLayer = new ol.layer.Tile({ source: new ol.source.OSM() });

    const map = new ol.Map({
      target: 'map',
      layers: [baseLayer, vectorLayer],
      view: new ol.View({
        projection: projection,
        center: [360350, 174350],
        zoom: 16
      }),
      controls: []
    });

    function loadAllExtents() {
      vectorSource.clear();
      const format = new ol.format.GeoJSON();
      extents.forEach((groupData) => {
        const groupId = groupData.properties.id;
        const features = format.readFeatures(groupData, {
          dataProjection: 'EPSG:27700',
          featureProjection: 'EPSG:27700'
        });
        features.forEach(feature => {
          feature.set('groupId', groupId);
          vectorSource.addFeature(feature);
        });
      });
    }

    function zoomToCurrentExtent() {
      const currentGroupId = extents[count].properties.id;

      const mainPolygonFeature = vectorSource.getFeatures().find(f =>
        f.get('groupId') === currentGroupId && f.get('featureType') === 'shape_polygon'
      );

      if (mainPolygonFeature) {
        const polygonExtent = mainPolygonFeature.getGeometry().getExtent();
        const view = map.getView();

        view.fit(polygonExtent, { padding: [20, 20, 20, 20], duration: 0, maxZoom: 19 });

        view.setZoom(view.getZoom() + 1);
      }
    }

    // Style description (TMF attributes)
    function updateStyleDescription() {
      const styleBox = document.getElementById('style-box');
      const descriptionLabel = document.getElementById('style-description');
      if (!styleBox || !descriptionLabel) return;
      const currentDescription = extents[count].features[0].properties.description;
      styleBox.style.setProperty('background-color', 'rgba(0, 102, 204, 0.4)', 'important');
      styleBox.style.setProperty('border', '2px solid rgba(0, 102, 204, 1)', 'important');
      descriptionLabel.textContent = currentDescription;
    }

    function saveAnswerState() {
      const selectedRadio = document.querySelector('input[name="defineRelationship"]:checked');
      if (selectedRadio) { answers[count] = selectedRadio.value; }
      else { answers[count] = null; }
    }

    function restoreAnswerState() {
      const savedAnswer = answers[count];
      const radios = document.querySelectorAll('input[name="defineRelationship"]');
      radios.forEach(radio => { radio.checked = (radio.value === savedAnswer); });
    }

    function clearError() {
      const summary = document.querySelector('.govuk-error-summary');
      if (summary) summary.remove();
      const inlineError = document.getElementById('radio-error-message');
      if (inlineError) inlineError.remove();
      const formGroup = document.querySelector('.govuk-radios').closest('.govuk-form-group');
      if (formGroup) formGroup.classList.remove('govuk-form-group--error');
    }

    function showError(message) {
      clearError();
      const formGroup = document.querySelector('.govuk-radios').closest('.govuk-form-group');
      if (formGroup) {
        formGroup.classList.add('govuk-form-group--error');
        const errorMessage = document.createElement('p');
        errorMessage.id = 'radio-error-message';
        errorMessage.className = 'govuk-error-message';
        errorMessage.innerHTML = `<span class="govuk-visually-hidden">Error:</span> ${message}`;
        formGroup.insertBefore(errorMessage, formGroup.querySelector('.govuk-fieldset'));
      }
      const errorSummary = document.createElement('div');
      errorSummary.className = 'govuk-error-summary';
      errorSummary.setAttribute('role', 'alert');
      errorSummary.setAttribute('tabindex', '-1');
      errorSummary.innerHTML = `<h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2><div class="govuk-error-summary__body"><ul class="govuk-list govuk-error-summary__list"><li><a href="#defineRelationship">${message}</a></li></ul></div>`;
      const mainContent = document.querySelector('.govuk-grid-row');
      if (mainContent) mainContent.parentElement.insertBefore(errorSummary, mainContent);
      errorSummary.focus();
    }

    const radiosContainer = document.querySelector('.govuk-radios');
    if (radiosContainer) {
      radiosContainer.addEventListener('change', () => {
        saveAnswerState();
        clearError();
      });
    }

    const totalPages = extents.length;
    const counterElement = document.getElementById('counter');
    function updateCounter() {
      counterElement.textContent = (count + 1) + " of " + totalPages;
    }

    document.getElementById('prevBtn').onclick = function () {
      clearError(); saveAnswerState();
      count--;
      if (count < 0) { count = 0; }
      restoreAnswerState();
      updateNavigationButtons(); updateCounter(); updateStyleDescription();
      vectorSource.changed(); zoomToCurrentExtent();
    };

    document.getElementById('nextBtn').addEventListener('click', function (event) {
      const selectedRadio = document.querySelector('input[name="defineRelationship"]:checked');
      if (!selectedRadio) {
        event.preventDefault(); showError("Select if the group is included in the text");
        return;
      }
      clearError(); saveAnswerState();
      if (count === totalPages - 1) {
        console.log('Final answers:', answers);
      } else {
        event.preventDefault();
        count++;
        restoreAnswerState();
        updateNavigationButtons(); updateCounter(); updateStyleDescription();
        vectorSource.changed(); zoomToCurrentExtent();
      }
    });

    function updateNavigationButtons() {
      const nextBtn = document.getElementById('nextBtn');
      const prevBtn = document.getElementById('prevBtn');
      if (count === totalPages - 1) { nextBtn.textContent = 'Mark text as completed'; }
      else { nextBtn.textContent = 'Save and next shape'; }
      if (count === 0) { prevBtn.style.display = 'none'; }
      else { prevBtn.style.display = 'inline-block'; }
    }

    document.getElementById('zoom-in').addEventListener('click', function () {
      map.getView().animate({ zoom: map.getView().getZoom() + 1, duration: 250 });
    });

    document.getElementById('zoom-out').addEventListener('click', function () {
      map.getView().animate({ zoom: map.getView().getZoom() - 1, duration: 250 });
    });

    // --- Initialization sequence ---
    loadAllExtents();
    updateNavigationButtons();
    updateCounter();
    updateStyleDescription();

    map.once('postrender', function () {
      baseLayer.setOpacity(0.3);
      zoomToCurrentExtent();
    });
  });
</script>

{% endblock %}