{% extends "app/views/layouts/entry-annotation.html" %}

{% set backLinkText = "Back to Task overview" %}
{% set backLinkHref = "/annotators/v3/titles/QR84291/entries-task-list" %}

{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/details/macro.njk" import govukDetails %}

{% block pageTitle %}
QR84291 – {{ serviceName }} – GOV.UK Prototype Kit
{% endblock %}

{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% block beforeContent %}

{{ super() }}
{{ govukBackLink({
text: backLinkText,
href: backLinkHref
}) }}

{% endblock %}

{% block content %}

<div class="govuk-grid-row">

  <div class="govuk-grid-column-one-half">
    <h2 class="govuk-heading-m">
      <span>Shape </span>
      <span id="counter">1 of 10</span>
    </h2>

    {% include "app/includes/annotators/style-box.html" %}

    <div>
      <div class="zoom-controls">
        <button id="zoom-in" class="zoom ol-zoom-in zoom-in" type="button" title="Zoom in">+<span
            class="govuk-visually-hidden">Zoom in</span></button>
        <button id="zoom-out" class="zoom ol-zoom-out zoom-out" type="button" title="Zoom out">-
          <span class="govuk-visually-hidden">Zoom out</span>
        </button>
      </div>
    </div>
    <div id="map" tabindex="0" aria-label="Image showing shape">
    </div>
  </div>

  <div class="govuk-grid-column-one-third">
    <form action="/annotators/v3/titles/QR84291/entries-task-list" method="post" novalidate>
      <div>
        <h2 class="govuk-heading-m">Paragraph 1</h2>

        <div class="entry-container">
          {% include "app/includes/entries/QR84291/inc_QR84291-entry-1.html" %}
        </div>

        {% include "app/includes/annotators/entry-extent-match-radios.html" %}

        <div id="hidden-answers-container"></div>

        <div class="govuk-button-group">
          <button id="prevBtn" class="govuk-button govuk-button--secondary" data-module="govuk-button" type="button">
            Previous shape
          </button>
          <br />
          <button id="nextBtn" class="govuk-button govuk-button--primary" data-module="govuk-button" type="submit">
            Save and next shape
          </button>
          <input type="hidden" name="QR84291Status" value="started">
          <br />
        </div>
      </div>
      <div style="height:480px;">
      </div>
    </form>
  </div>

</div>

{% endblock %}

{% block pageScripts %}

<link rel="stylesheet" href="/public/map/css/map-styles.css">

<script src="/public/map/jquery.min.js"></script>

<script src="/public/map/ol.js"></script>
<script src="/public/map/proj4.js"></script>
<script src="/public/map/union.js"></script>
<script src="/public/map/draw_hole.js"></script>

<script src="/public/map/hatching_style.js"></script>
<script src="/public/map/map_styles.js"></script>

<script src="/public/map/master_map_vector_layer_fixed.js"></script>
<script src="/public/map/snap_to_vector_layer.js"></script>

<script src="/public/map/map_undo_v1.js"></script>
<script src="/public/map/map_controls.js"></script>
<script src="/public/map/map_helpers_v1.js"></script>

<script src="/public/map/map_config.js"></script>

<script type="text/javascript">
  var termsLink = "";
  var mastermap_api_key = "{{ data.API_KEY }}";
  var map_base_layer_view_name = "m0100";
  var wfs_server_url = "{{ data.WFS_URL }}";
  var wmts_server_url = "{{ data.WMTS_URL }}";

  MAP_CONFIG.setBaseLayer(MAP_CONFIG.base_layer_zindex, MAP_CONFIG.mastermapResolutions, MAP_CONFIG.projection, termsLink, false);
</script>

<script src="/public/map/map.js"></script>
<script src="/public/map/save_geometries.js"></script>

<script src="/public/map/keyboard_panning.js"></script>
<script src="/public/map/postcode_actions.js"></script>
<!-- <script src="/public/map/custom_controls.js"></script> -->
<script>
  // Initialize the extent counter
  let currentPage = 1;
  const totalPages = 14;
  const counterElement = document.getElementById('counter');
  const nextButton = document.getElementById('nextBtn');
  const prevButton = document.getElementById('prevBtn');
  // Update extent counter function
  function updateCounter() {
    counterElement.textContent = currentPage + " of " + totalPages;
  }
  // Next button click handler
  nextButton.addEventListener('click', function () {
    currentPage = (currentPage % totalPages) + 1; // Loop back to 1 after reaching 14
    updateCounter();
  });
  // Previous button click handler
  prevButton.addEventListener('click', function () {
    currentPage = currentPage - 1;
    if (currentPage < 1) {
      currentPage = totalPages; // Loop back to 14 if going below 1
    }
    updateCounter();
  });
</script>

<script type="text/javascript">
  // Add open layers map controls
  var controls;
  var center = [];
  let count = 0;
  MAP_HELPERS.init_controls(map, controls);

  ///////////////////////////////////////////////
  // initialise 
  ///////////////////////////////////////////////
  $(document).ready(function () {

    let answers = new Array(extents.length).fill(null);

    const styleFunction = function (feature) {
      const featureType = feature.get('type');
      const currentExtentId = extents[count].features[0].properties.id;

      if (featureType === 'polygon') {
        const isActive = (feature.getId() === currentExtentId);
        if (isActive) {
          return new ol.style.Style({
            fill: new ol.style.Fill({ color: 'rgba(0, 102, 204, 0.4)' }),
            stroke: new ol.style.Stroke({ color: 'rgba(0, 102, 204, 1)', width: 3 })
          });
        } else {
          return new ol.style.Style({
            fill: new ol.style.Fill({ color: 'rgba(177, 180, 182, 0.1)' }), // #b1b4b6
            stroke: new ol.style.Stroke({ color: 'rgba(177, 180, 182, 1)', width: 2 })
          });
        }
      }

      if (featureType === 'annotation') {
        const annotationLabel = feature.get('label');
        const styleColor = '#505a5f';
        const style = new ol.style.Style({
          stroke: new ol.style.Stroke({ color: styleColor, width: 4 })
        });
        if (feature.getGeometry().getType() === 'Point') {
          style.setText(new ol.style.Text({
            text: annotationLabel, font: 'bold 20px Arial',
            fill: new ol.style.Fill({ color: styleColor }),
            stroke: new ol.style.Stroke({ color: 'white', width: 3 }),
            offsetX: 20, textAlign: 'left'
          }));
        }
        return style;
      }
    };

    MAP_CONFIG.draw_layer.setStyle(styleFunction);

    function loadAllExtents() {
      MAP_CONFIG.draw_source.clear();
      const format = new ol.format.GeoJSON();

      extents.forEach(extentData => {
        const feature = format.readFeatures(extentData)[0];
        feature.setId(feature.get('id'));
        feature.set('type', 'polygon');
        MAP_CONFIG.draw_source.addFeature(feature);
      });

      const allPolygonsExtent = MAP_CONFIG.draw_source.getExtent();
      const rightmostX = allPolygonsExtent ? allPolygonsExtent[2] : 0;
      const targetFeature2 = MAP_CONFIG.draw_source.getFeatureById(1000);
      const targetFeature3 = MAP_CONFIG.draw_source.getFeatureById(1001);

      if (targetFeature2) {
        const centerPoint = targetFeature2.getGeometry().getInteriorPoint().getCoordinates();
        const endPoint = [rightmostX + 3, 181751.5];
        const annotationFeatures = [
          new ol.Feature({ geometry: new ol.geom.LineString([centerPoint, endPoint]) }),
          new ol.Feature({ geometry: new ol.geom.LineString([[endPoint[0] - 1.5, endPoint[1] + 1.5], endPoint, [endPoint[0] - 1.5, endPoint[1] - 1.5]]) }),
          new ol.Feature({ geometry: new ol.geom.Point(endPoint) })
        ];
        annotationFeatures.forEach(f => f.setProperties({ type: 'annotation', label: '2' }));
        MAP_CONFIG.draw_source.addFeatures(annotationFeatures);
      }
      if (targetFeature3) {
        const centerPoint = targetFeature3.getGeometry().getInteriorPoint().getCoordinates();
        const endPoint = [rightmostX + 3, 181747];
        const annotationFeatures = [
          new ol.Feature({ geometry: new ol.geom.LineString([centerPoint, endPoint]) }),
          new ol.Feature({ geometry: new ol.geom.LineString([[endPoint[0] - 1.5, endPoint[1] + 1.5], endPoint, [endPoint[0] - 1.5, endPoint[1] - 1.5]]) }),
          new ol.Feature({ geometry: new ol.geom.Point(endPoint) })
        ];
        annotationFeatures.forEach(f => f.setProperties({ type: 'annotation', label: '3' }));
        MAP_CONFIG.draw_source.addFeatures(annotationFeatures);
      }
    }

    function zoomToCurrentExtent() {
      const currentExtentId = extents[count].features[0].properties.id;
      const currentFeature = MAP_CONFIG.draw_source.getFeatureById(currentExtentId);
      if (!currentFeature) return;
      let extentToFit = currentFeature.getGeometry().getExtent();
      if (currentExtentId === 1000) {
        const arrowFeatures = MAP_CONFIG.draw_source.getFeatures().filter(f => f.get('label') === '2');
        arrowFeatures.forEach(arrowPart => {
          ol.extent.extend(extentToFit, arrowPart.getGeometry().getExtent());
        });
      }
      map.getView().fit(extentToFit, { padding: [80, 80, 80, 80], maxZoom: 18 });
    }

    // Show the active feaure on top:
    MAP_CONFIG.draw_layer.setRenderOrder(function (a, b) {
      const currentId = extents[count].features[0].properties.id;
      if (a.getId() === currentId) return 1;
      if (b.getId() === currentId) return -1;
      return 0;
    });

    function updateStyleDescription() {
      const styleBox = document.getElementById('style-box');
      const descriptionLabel = document.getElementById('style-description');
      if (!styleBox || !descriptionLabel) return;
      const currentDescription = extents[count].features[0].properties.description;
      styleBox.style.setProperty('background-color', 'rgba(0, 102, 204, 0.4)', 'important');
      styleBox.style.setProperty('border', '2px solid rgba(0, 102, 204, 1)', 'important');
      descriptionLabel.textContent = currentDescription;
    }

    function saveAnswerState() {
      const selectedRadio = document.querySelector('input[name="defineRelationship"]:checked');
      if (selectedRadio) { answers[count] = selectedRadio.value; }
      else { answers[count] = null; }
    }

    function restoreAnswerState() {
      const savedAnswer = answers[count];
      const radios = document.querySelectorAll('input[name="defineRelationship"]');
      radios.forEach(radio => {
        radio.checked = (radio.value === savedAnswer);
      });
    }

    // Error handling
    function clearError() {
      const summary = document.querySelector('.govuk-error-summary');
      if (summary) summary.remove();

      const inlineError = document.getElementById('radio-error-message');
      if (inlineError) inlineError.remove();

      const formGroup = document.querySelector('.govuk-radios').closest('.govuk-form-group');
      if (formGroup) {
        formGroup.classList.remove('govuk-form-group--error');
      }
    }

    function showError(message) {
      clearError();

      // Add error class to the radio group
      const formGroup = document.querySelector('.govuk-radios').closest('.govuk-form-group');
      if (formGroup) {
        formGroup.classList.add('govuk-form-group--error');
        const errorMessage = document.createElement('p');
        errorMessage.id = 'radio-error-message';
        errorMessage.className = 'govuk-error-message';
        errorMessage.innerHTML = `<span class="govuk-visually-hidden">Error:</span> ${message}`;
        formGroup.insertBefore(errorMessage, formGroup.querySelector('.govuk-fieldset'));
      }

      // Create and display the error summary box at the top of the page
      const errorSummary = document.createElement('div');
      errorSummary.className = 'govuk-error-summary';
      errorSummary.setAttribute('role', 'alert');
      errorSummary.setAttribute('tabindex', '-1');
      errorSummary.innerHTML = `
        <h2 class="govuk-error-summary__title" id="error-summary-title">
          There is a problem
        </h2>
        <div class="govuk-error-summary__body">
          <ul class="govuk-list govuk-error-summary__list">
            <li><a href="#defineRelationship">${message}</a></li>
          </ul>
        </div>
      `;

      const mainContent = document.querySelector('.govuk-grid-row');
      if (mainContent) {
        mainContent.parentElement.insertBefore(errorSummary, mainContent);
      }
      errorSummary.focus();
    }

    const radiosContainer = document.querySelector('.govuk-radios');
    if (radiosContainer) {
      radiosContainer.addEventListener('change', () => {
        saveAnswerState();
        clearError(); // Clear error as soon as a selection is made
      });
    }

    map.once('postrender', function (event) {
      MAP_CONFIG.base_layer.setOpacity(0.3);
    });

    const totalPages = extents.length;
    const counterElement = document.getElementById('counter');
    function updateCounter() {
      counterElement.textContent = (count + 1) + " of " + totalPages;
    }

    document.getElementById('prevBtn').onclick = function () {
      clearError();
      saveAnswerState();
      count--;
      if (count < 0) { count = totalPages - 1; }
      restoreAnswerState();
      updateNavigationButtons(); updateCounter(); updateStyleDescription();
      MAP_CONFIG.draw_source.changed(); zoomToCurrentExtent();
    };

    document.getElementById('nextBtn').addEventListener('click', function (event) {
      const selectedRadio = document.querySelector('input[name="defineRelationship"]:checked');
      if (!selectedRadio) {
        event.preventDefault();
        showError("Select if the shape is included in the text");
        return;
      }

      clearError();
      saveAnswerState();

      if (count === totalPages - 1) {
        console.log('Final answers:', answers);
        // Let the form submit
      } else {
        event.preventDefault();
        count++;
        restoreAnswerState();
        updateNavigationButtons(); updateCounter(); updateStyleDescription();
        MAP_CONFIG.draw_source.changed(); zoomToCurrentExtent();
      }
    });

    function updateNavigationButtons() {
      const nextBtn = document.getElementById('nextBtn');
      const prevBtn = document.getElementById('prevBtn');
      if (count === totalPages - 1) { nextBtn.textContent = 'Mark text as done'; }
      else { nextBtn.textContent = 'Save and next shape'; }
      if (count === 0) { prevBtn.style.display = 'none'; }
      else { prevBtn.style.display = 'inline-block'; }
    }

    // --- Add event listeners for custom zoom buttons ---
    document.getElementById('zoom-in').addEventListener('click', function () {
      const view = map.getView();
      view.animate({
        zoom: view.getZoom() + 1,
        duration: 250
      });
    });

    document.getElementById('zoom-out').addEventListener('click', function () {
      const view = map.getView();
      view.animate({
        zoom: view.getZoom() - 1,
        duration: 250
      });
    });

    loadAllExtents();
    updateNavigationButtons();
    updateCounter();
    updateStyleDescription();
    zoomToCurrentExtent();
  });

  // Extents array
  let extents = [
    { "features": [{ "geometry": { "coordinates": [[[532042.65, 181758.8], [532046.85, 181752.4], [532047.15, 181751.9], [532047.5, 181751.45], [532048.3, 181750.1], [532051.95, 181752.55], [532052.25, 181752.75], [532051.5, 181754.0], [532050.8, 181755.0], [532046.45, 181761.45], [532042.65, 181758.8]]], "type": "Polygon" }, "properties": { "id": 1000, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532032.2, 181739.4], [532036.2, 181734.35], [532042.7, 181739.1], [532046.3, 181741.7], [532048.35, 181743.2], [532053.1, 181736.4], [532060.45, 181740.65], [532051.95, 181752.55], [532048.3, 181750.1], [532047.5, 181751.45], [532046.85, 181752.4], [532042.65, 181758.8], [532036.3, 181754.65], [532040.7, 181747.9], [532032.7, 181742.95], [532034.1, 181740.7], [532032.2, 181739.4]]], "type": "Polygon" }, "properties": { "id": 1001, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532032.7, 181742.95], [532034.1, 181740.7], [532038.9, 181743.9], [532042, 181745.9], [532042.5, 181746.25], [532043.55, 181746.95], [532045.05, 181747.95], [532048.3, 181750.1], [532051.95, 181752.55], [532052.25, 181752.75], [532051.5, 181754], [532050.8, 181755], [532046.85, 181752.4], [532042.65, 181758.8], [532036.3, 181754.65], [532040.7, 181747.9], [532032.7, 181742.95]]], "type": "Polygon" }, "properties": { "id": 1002, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532017.1, 181740.25], [532023.3, 181733.7], [532023.9, 181734.05], [532028.75, 181737.2], [532031.05, 181738.65], [532032.2, 181739.4], [532034.1, 181740.7], [532038.9, 181743.9], [532042, 181745.9], [532042.5, 181746.25], [532043.55, 181746.95], [532045.05, 181747.95], [532048.3, 181750.1], [532047.5, 181751.45], [532046.85, 181752.4], [532042.65, 181758.8], [532036.3, 181754.65], [532029.7, 181750.4], [532017.45, 181742.55], [532017.1, 181740.25]]], "type": "Polygon" }, "properties": { "id": 1003, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532017.1, 181740.25], [532023.3, 181733.7], [532023.9, 181734.05], [532030.55, 181725.8], [532035.3, 181729.15], [532038.55, 181731.4], [532036.2, 181734.35], [532042.7, 181739.1], [532046.3, 181741.7], [532048.35, 181743.2], [532053.1, 181736.4], [532060.45, 181740.65], [532061.9, 181737.85], [532063.75, 181739.25], [532064.6, 181737.6], [532065.5, 181738], [532069.1, 181739.8], [532073.95, 181742.25], [532076.5, 181736.6], [532076.9, 181736.85], [532077.35, 181737.1], [532077.5, 181736.8], [532079.3, 181737.45], [532078.65, 181742], [532082.2, 181742.5], [532080.5, 181753.8], [532073.85, 181752.8], [532073.15, 181756.8], [532073.05, 181758.75], [532072.85, 181759.45], [532069.7, 181764.5], [532072.6, 181766.15], [532067.8, 181776.05], [532058.3, 181769.8], [532046.45, 181761.45], [532042.65, 181758.8], [532036.3, 181754.65], [532029.7, 181750.4], [532017.45, 181742.55], [532017.1, 181740.25]]], "type": "Polygon" }, "properties": { "id": 1005, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532042.5, 181746.25], [532042, 181745.9], [532040.7, 181747.9], [532036.3, 181754.65], [532042.65, 181758.8], [532046.85, 181752.4], [532047.5, 181751.45], [532048.3, 181750.1], [532045.05, 181747.95], [532043.55, 181746.95], [532042.5, 181746.25]]], "type": "Polygon" }, "properties": { "id": 1006, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532062.65, 181763.15], [532064.1, 181760.85], [532062.15, 181759.5], [532059.45, 181757.65], [532052.25, 181752.75], [532051.5, 181754], [532050.8, 181755], [532046.45, 181761.45], [532058.3, 181769.8], [532062.65, 181763.15]]], "type": "Polygon" }, "properties": { "id": 1007, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532058.3, 181769.8], [532062.65, 181763.15], [532064.1, 181760.85], [532069.7, 181764.5], [532072.6, 181766.15], [532067.8, 181776.05], [532058.3, 181769.8]]], "type": "Polygon" }, "properties": { "id": 1008, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" },
    { "features": [{ "geometry": { "coordinates": [[[532051.95, 181792.9], [532059.05, 181791.5], [532065.3, 181781.4], [532054.6, 181774.3], [532046.3, 181768.85], [532042, 181775.2], [532040.85, 181775.5], [532036.35, 181782.95], [532044.8, 181788.4], [532051.95, 181792.9]]], "type": "Polygon" }, "properties": { "id": 1009, "matchable": true, "description": "Edged and tinted blue" }, "type": "Feature" }], "type": "FeatureCollection" }
  ]
</script>

{% endblock %}