{% extends "app/views/layouts/annotation-3-column.html" %}
{% set backLinkText = "Back to Task overview" %}
{% set backLinkHref = "/annotators/v3/titles/BN78354/entries-task-list" %}

{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/details/macro.njk" import govukDetails %}

{% block pageTitle %}
BN78354 – {{ serviceName }} – GOV.UK Prototype Kit
{% endblock %}

{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% block content %}

<div class="govuk-grid-row">

    <div class="govuk-grid-column-one-third" style="width: 10%;">
    controls
  </div>

  <div class="govuk-grid-column-one-half" style="width: 50%;">
    <div>
      <div class="zoom-controls">
        <button id="zoom-in" class="zoom ol-zoom-in zoom-in" type="button" title="Zoom in">+<span
            class="govuk-visually-hidden">Zoom in</span></button>
        <button id="zoom-out" class="zoom ol-zoom-out zoom-out" type="button" title="Zoom out">-
          <span class="govuk-visually-hidden">Zoom out</span>
        </button>
      </div>
    </div>
    <div id="map" class="maintain-llc-map" tabindex="0" aria-label="Image showing search extent">
    </div>
  </div>

    <div class="govuk-grid-column-one-third" style="width: 30%;">
    <form action="/annotators/v3/save-answers" method="post" novalidate>

      <input type="hidden" name="titleNumber" value="BN78354">
      <input type="hidden" name="completedTextTitle" id="completed-text-title">

      <div>
        <h2 class="govuk-heading-m">Text 1</h2>

        <div class="entry-container">
          {% include "app/includes/entries/QR84291/inc_QR84291-entry-1.html" %}
        </div>

        <div id="hidden-answers-container"></div>

        <div class="govuk-button-group">
          {{ govukButton({
          text: "Mark text as done",
          element: "button",
          isPrimary: true
          }) }}
          <input type="hidden" name="BN78354Status" value="completed">
        </div>
      </div>
      <div style="height:480px;">
      </div>
    </form>
  </div>

</div>

{% endblock %}

{% block pageScripts %}

<link rel="stylesheet" href="/public/map/css/map-styles.css">

<script src="/public/map/jquery.min.js"></script>
<script src="/public/map/ol.js"></script>
<script src="/public/map/proj4.js"></script>

<script type="text/javascript">

  // ===================================================================
  // PAGE CONFIG
  // ===================================================================

  const groupStyles = [
    { color: 'rgba(51, 102, 51, 1)', description: "Group 1 Style" },
    { color: 'rgba(51, 102, 51, 1)', description: "Group 2 Style" },
    { color: 'rgba(51, 102, 51, 1)', description: "Group 3 Style" }
  ];

  const extents = [
    // --- GROUP 1 ---
    {
      "type": "FeatureCollection",
      "properties": { "id": "group1" },
      "features": [
        {
          "type": "Feature", "properties": { "featureType": "shape_polygon", "matchable": true },
          "geometry": {
            "type": "Polygon", "coordinates": [[[360255.416, 174262.873], [360256.886, 174266.78], [360257.708, 174268.964], [360259.727, 174274.331], [360261.809, 174279.865], [360262.559, 174281.859], [360264.2, 174286.22], [360266.256, 174285.502], [360267.55, 174285.05], [360271.5, 174283.7], [360277, 174281.75], [360279.907, 174289.777], [360280.342, 174290.978], [360280.431, 174290.918], [360280.35, 174291], [360274.2, 174297.35], [360272.804, 174298.791], [360272.147, 174299.437], [360269.975, 174301.572], [360267.975, 174303.539], [360267.15, 174304.35], [360263.1, 174308.85], [360262.815, 174308.039], [360261.55, 174304.45], [360258.55, 174296.1], [360258.1, 174294.65], [360256.023, 174288.752], [360255.01, 174285.873], [360251.099, 174274.767], [360248.904, 174268.533], [360247.822, 174265.461], [360247.319, 174264.033], [360245.832, 174259.809], [360245.595, 174259.136], [360249.973, 174257.627], [360253.044, 174256.568], [360255.416, 174262.873]]]
          }
        },
        { "type": "Feature", "properties": { "featureType": "arrow_line" }, "geometry": { "type": "LineString", "coordinates": [[360259.813, 174291.088], [360299.34, 174276.952]] } },
        { "type": "Feature", "properties": { "featureType": "arrow_head" }, "geometry": { "type": "Polygon", "coordinates": [[[360299.141, 174276.395], [360300.099, 174276.682], [360299.54, 174277.511], [360299.34, 174276.952], [360299.141, 174276.395]]] } },
        { "type": "Feature", "properties": { "featureType": "label", "text": "BL124172" }, "geometry": { "type": "Point", "coordinates": [360310.759, 174275.494] } }
      ]
    },
    // --- GROUP 2 ---
    {
      "type": "FeatureCollection",
      "properties": { "id": "group2" },
      "features": [
        {
          "type": "Feature", "properties": { "featureType": "shape_polygon", "matchable": true },
          "geometry": {
            "type": "Polygon", "coordinates": [[[360293.301, 174258.003], [360294.9, 174263.4], [360293.7, 174263.756], [360293.55, 174263.8], [360290.5, 174264.75], [360291, 174266.2], [360291.6, 174267.9], [360287.7, 174269.45], [360286.8, 174267.3], [360286.35, 174266.05], [360286, 174265.25], [360284.75, 174262.35], [360284.4, 174261.45], [360284.144, 174260.794], [360283.645, 174259.471], [360283.565, 174259.321], [360281.55, 174254.15], [360291.3, 174251.25], [360293.276, 174257.895], [360293.301, 174258.003]]]
          }
        },
        { "type": "Feature", "properties": { "featureType": "arrow_line" }, "geometry": { "type": "LineString", "coordinates": [[360287.55, 174254.644], [360299.33, 174272.099], [360298.839, 174272.431], [360299.781, 174272.768], [360299.82, 174271.768], [360299.33, 174272.099]] } },
        { "type": "Feature", "properties": { "featureType": "label", "text": "BL124172" }, "geometry": { "type": "Point", "coordinates": [360310.759, 174275.494] } }
      ]
    },
    // --- GROUP 3 ---
    {
      "type": "FeatureCollection",
      "properties": { "id": "group3" },
      "features": [
        {
          "type": "Feature", "properties": { "featureType": "shape_polygon", "matchable": true },
          "geometry": { "type": "Polygon", "coordinates": [[[360278.75, 174275.65], [360279.693, 174278.132], [360279.7, 174278.15], [360276, 174279.45], [360275.411, 174279.658], [360275.014, 174278.586], [360273.185, 174273.649], [360272.343, 174271.378], [360267.565, 174258.484], [360269.65, 174257.75], [360271.75, 174257.05], [360272, 174257.75], [360274.73, 174264.98], [360275.753, 174267.649], [360278.75, 174275.65]]] }
        },
        { "type": "Feature", "properties": { "featureType": "arrow_line" }, "geometry": { "type": "LineString", "coordinates": [[360272.373, 174264.222], [360299.173, 174274.253], [360298.965, 174274.807], [360299.927, 174274.535], [360299.38, 174273.699], [360299.173, 174274.253]] } },
        { "type": "Feature", "properties": { "featureType": "arrow_head" }, "geometry": { "type": "Polygon", "coordinates": [[[360299.38, 174273.699], [360299.927, 174274.535], [360298.965, 174274.807], [360299.173, 174274.253], [360299.38, 174273.699]]] } },
        { "type": "Feature", "properties": { "featureType": "label", "text": "BL124172" }, "geometry": { "type": "Point", "coordinates": [360310.759, 174275.494] } }
      ]
    }
  ];

  // ===================================================================
  // APPLICATION LOGIC
  // ===================================================================
  $(window).on('load', function () {

    // Define colors for consistency
    const selectColor = 'rgba(0, 48, 120, 1)';
    const selectFillColor = 'rgba(0, 48, 120, 0.5)';
    // A 50% lighter version of rgb(0, 48, 120) is rgb(107, 138, 214)
    const hoverColor = 'rgba(107, 138, 214, 1)';
    const hoverFillColor = 'rgba(107, 138, 214, 0.5)'; // New color for the hover fill

    const selectStyle = new ol.style.Style({
      fill: new ol.style.Fill({ color: selectFillColor }),
      stroke: new ol.style.Stroke({
        color: selectColor, 
        width: 3,
        lineDash: [6, 6] 
      }),
      zIndex: 2 // Ensure select is on top
    });

    // --- Interactions ---
    // The selectClick interaction must be defined before selectHover so it can be referenced.
    const selectClick = new ol.interaction.Select({
      condition: ol.events.condition.click,
      filter: (feature) => feature.get('matchable') === true,
      style: selectStyle,
      multi: true, // Allow multiple features to be selected
      toggleCondition: ol.events.condition.click // Click a selected feature to deselect it
    });

    const selectHover = new ol.interaction.Select({
      condition: ol.events.condition.pointerMove,
      filter: (feature) => feature.get('matchable') === true,
      style: function(feature) {
        // This style now applies to any hovered feature, regardless of its selection state.
        return new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: hoverColor,
                width: 3.5
            }),
            // Always apply the new light blue fill on hover
            fill: new ol.style.Fill({ color: hoverFillColor }),
            zIndex: 3 // Ensure hover style is drawn on top of everything else
        });
      }
    });

    // --- Styling Logic ---
    function createActiveStyles(color) {
      return {
        shapePolygon: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: color, width: 2.5 }),
          fill: new ol.style.Fill({ color: 'rgba(0,0,0,0)' })
        }),
        arrowLine: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: color, width: 2.5 })
        }),
        arrowHead: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: color, width: 2.5 })
        }),
        label: new ol.style.Style({
          text: new ol.style.Text({
            font: '32px "Arial", arial, sans-serif',
            fill: new ol.style.Fill({ color: color }),
            stroke: new ol.style.Stroke({ color: 'white', width: 3 }),
            offsetX: -50,
            offsetY: -0,
            textAlign: 'left'
          })
        })
      };
    }

    const styleCache = {};

    const styleFunction = function (feature) {
      const featureGroupId = feature.get('groupId');
      if (!featureGroupId) return null; 
      const groupIndex = parseInt(featureGroupId.replace('group', ''), 10) - 1;

      if (groupIndex >= 0 && groupIndex < groupStyles.length) {
        const featureType = feature.get('featureType');
        const color = groupStyles[groupIndex].color;

        if (!styleCache[color]) {
          styleCache[color] = createActiveStyles(color);
        }
        const activeStyles = styleCache[color];

        switch (featureType) {
          case 'shape_polygon':
            return activeStyles.shapePolygon;
          case 'arrow_line':
            return activeStyles.arrowLine;
          case 'arrow_head':
            return activeStyles.arrowHead;
          case 'label':
            const labelStyle = activeStyles.label;
            labelStyle.getText().setText(feature.get('text'));
            return labelStyle;
        }
      }
      return null;
    };

    proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs");
    ol.proj.proj4.register(proj4);
    const projection = ol.proj.get('EPSG:27700');

    const vectorSource = new ol.source.Vector();
    const vectorLayer = new ol.layer.Vector({ source: vectorSource, style: styleFunction });
    const baseLayer = new ol.layer.Tile({ source: new ol.source.OSM() });

    //  MAP CONFIGURATION
    const map = new ol.Map({
      target: 'map',
      layers: [baseLayer, vectorLayer],
      view: new ol.View({
        projection: projection,
        center: [360350, 174350],
        zoom: 16
      }),
      controls: []
    });

    // --- Focus style on click-and-hold ---
    let focusedFeature = null;

    map.on('pointerdown', function (e) {
      const feature = map.forEachFeatureAtPixel(e.pixel, f => (f.get('matchable') === true ? f : undefined));

      if (feature) {
        focusedFeature = feature;
        const selectedFeatures = selectClick.getFeatures();
        const isSelected = selectedFeatures.getArray().includes(feature);
        const baseStyle = isSelected ? selectStyle : styleFunction(feature);

        if (baseStyle) {
          const styles = Array.isArray(baseStyle) ? baseStyle.map(s => s.clone()) : [baseStyle.clone()];
          const mainStroke = styles[0].getStroke();

          if (mainStroke) {
            const focusBorderStyle = new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'rgba(255, 221, 0, 1)',
                width: mainStroke.getWidth() + 4 // Adds a 2px yellow border
              })
            });
            // Apply styles in order: border first, then original style on top
            feature.setStyle([focusBorderStyle, ...styles]);
          }
        }
      }
    });

    map.on('pointerup', function () {
      if (focusedFeature) {
        focusedFeature.setStyle(null); // Revert to default style management
        focusedFeature = null;
      }
    });

    // Add Interactions to the map
    map.addInteraction(selectHover);
    map.addInteraction(selectClick);

    function loadAllExtents() {
      vectorSource.clear();
      const format = new ol.format.GeoJSON();
      extents.forEach((groupData) => {
        const groupId = groupData.properties.id;
        const features = format.readFeatures(groupData, {
          dataProjection: 'EPSG:27700',
          featureProjection: 'EPSG:27700'
        });
        features.forEach(feature => {
          feature.set('groupId', groupId); 
          if (feature.get('featureType') === undefined && groupData.features.find(f => f.geometry === feature.getGeometry())) {
              let originalFeature = groupData.features.find(f => f.geometry === feature.getGeometry());
              if(originalFeature) {
                feature.setProperties(originalFeature.properties);
              }
          }
          vectorSource.addFeature(feature);
        });
      });
    }

    function zoomToAllExtents() {
      const extent = vectorSource.getExtent();
      if (extent && ol.extent.getArea(extent) > 0) {
        map.getView().fit(extent, { padding: [50, 50, 50, 50], duration: 0, maxZoom: 20 });
      }
    }

    document.getElementById('zoom-in').addEventListener('click', function () {
      map.getView().animate({ zoom: map.getView().getZoom() + 1, duration: 250 });
    });

    document.getElementById('zoom-out').addEventListener('click', function () {
      map.getView().animate({ zoom: map.getView().getZoom() - 1, duration: 250 });
    });

    // --- Initialization sequence ---
    loadAllExtents();

    map.once('postrender', function () {
      baseLayer.setOpacity(0.4);
      zoomToAllExtents();
    });
  });
</script>

{% endblock %}